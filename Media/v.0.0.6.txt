//=============================== IMPORTS ===============================//
import 'dotenv/config';
import qrcode from 'qrcode-terminal';
import cron from 'node-cron';
import pkg from 'whatsapp-web.js';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const { Client, LocalAuth, MessageMedia } = pkg;

// Pour g√©rer __dirname en ES Modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

//=============================== VARIABLES ===============================//
const messages = [
  //"üì¢ Info quizz üß†:  A partir de demain suivez un mini quizz lanc√© le matin √† 7H00 et corrig√© √† 18H00 ! R√©agissez avec üü£üî¥üü°üü¢ correspondant √† la bonne r√©ponse.",
  //"üìå Tips du jour : üß† L‚Äôintelligence artificielle, c‚Äôest un cerveau num√©rique qui apprend comme toi en cours : plus il voit, plus il comprend !",

  "‚ùì Quizz 1 ‚Äì √Ä quoi sert la broche GND sur Arduino ?\nüü£ Alimenter un capteur\nüî¥ Envoyer des donn√©es\nüü° Se connecter √† la masse √©lectrique\nüü¢ Contr√¥ler un moteur",
  "‚ùì Quizz 2 ‚Äì Que fait une r√©sistance ?\nüü£ Accumule l‚Äô√©nergie\nüî¥ Limite le courant √©lectrique\nüü° Interrompt le circuit\nüü¢ Amplifie le signal",
  "‚ùì Quizz 3 ‚Äì Quelle est la vitesse standard de Serial.begin ?\nüü£ 4800 bauds\nüî¥ 9600 bauds\nüü° 14400 bauds\nüü¢ 115200 bauds",
  "‚ùì Quizz 4 ‚Äì Quel composant stocke une charge √©lectrique ?\nüü£ Diode\nüî¥ Transistor\nüü° Condensateur\nüü¢ LED",
  "‚ùì Quizz 5 ‚Äì √Ä quoi sert la fonction delay() sur Arduino ?\nüü£ Boucler le programme\nüî¥ Attendre un certain temps\nüü° Lancer le bootloader\nüü¢ Lire un capteur",
  "‚ùì Quizz 6 ‚Äì L‚ÄôIA apprend √† partir de :\nüü£ Pri√®res\nüî¥ R√®gles fixes\nüü° Donn√©es\nüü¢ Mots-cl√©s",
  "‚ùì Quizz 7 ‚Äì Un neurone artificiel :\nüü£ Est une cellule biologique\nüî¥ Traite un signal d‚Äôentr√©e\nüü° Est un microcontr√¥leur\nüü¢ Est une diode",
  "‚ùì Quizz 8 ‚Äì Le machine learning sert √† :\nüü£ Pr√©dire √† partir d‚Äôexemples\nüî¥ Compiler un programme\nüü° Recharger des batteries\nüü¢ Refroidir les circuits",
  "‚ùì Quizz 9 ‚Äì Le deep learning utilise :\nüü£ Des transistors\nüî¥ Des capteurs de mouvement\nüü° Des r√©seaux de neurones profonds\nüü¢ Des batteries au lithium",
  "‚ùì Quizz 10 ‚Äì Une image peut √™tre comprise par une IA en la transformant en :\nüü£ Couleurs\nüî¥ Sons\nüü° Donn√©es num√©riques\nüü¢ Langage C++",
  "‚ùì Quizz 11 ‚Äì Le capteur LDR d√©tecte :\nüü£ Le son\nüî¥ La lumi√®re\nüü° L‚Äôhumidit√©\nüü¢ Le mouvement",
  "‚ùì Quizz 12 ‚Äì Quelle fonction mesure une tension analogique sur Arduino ?\nüü£ digitalRead()\nüî¥ analogWrite()\nüü° analogRead()\nüü¢ pinMode()",
  "‚ùì Quizz 13 ‚Äì L‚Äôunit√© de la tension est :\nüü£ Ohm\nüî¥ Amp√®re\nüü° Volt\nüü¢ Watt",
  "‚ùì Quizz 14 ‚Äì En IA, NLP signifie :\nüü£ Neuron Learning Processor\nüî¥ Natural Language Processing\nüü° Neural Loop Pipeline\nüü¢ Non Linear Prediction",
  "‚ùì Quizz 15 ‚Äì L‚ÄôIA g√©n√©rative peut :\nüü£ Apprendre seule sans donn√©es\nüî¥ √âcrire des textes, images, sons\nüü° Modifier le hardware\nüü¢ Compiler du code sans erreurs",
  "‚ùì Quizz 16 ‚Äì Quel composant est polaris√© ?\nüü£ R√©sistance\nüî¥ LED\nüü° Breadboard\nüü¢ Fils Dupont",
  "‚ùì Quizz 17 ‚Äì Que mesure le capteur DHT11 ?\nüü£ Bruit\nüî¥ Temp√©rature et humidit√©\nüü° Mouvement\nüü¢ Lumi√®re",
  "‚ùì Quizz 18 ‚Äì L‚Äôapprentissage supervis√© signifie :\nüü£ L‚ÄôIA s‚Äôauto-entraine\nüî¥ On lui fournit des exemples avec r√©ponses\nüü° On la programme ligne par ligne\nüü¢ Elle imite l‚Äôhumain sans donn√©es",
  "‚ùì Quizz 19 ‚Äì Une breadboard sert √† :\nüü£ Coder\nüî¥ Prototyper sans souder\nüü° Afficher un signal\nüü¢ Sauver le projet",
  "‚ùì Quizz 20 ‚Äì Une IA bien entra√Æn√©e peut :\nüü£ Remplacer tous les humains\nüî¥ R√©pondre avec logique sur des cas appris\nüü° Cr√©er du code sans bug\nüü¢ Pr√©voir l‚Äôavenir sans erreur"
];

const reponses = [
  //"üí° Quizz 1 ‚Äì √Ä quoi sert la broche GND sur Arduino ?\nBonne r√©ponse : üü° Se connecter √† la masse √©lectrique",
  "üí° Quizz 2 ‚Äì Que fait une r√©sistance ?\nBonne r√©ponse : üî¥ Limite le courant √©lectrique",
  "üí° Quizz 3 ‚Äì Quelle est la vitesse standard de Serial.begin ?\nBonne r√©ponse : üî¥ 9600 bauds",
  "üí° Quizz 4 ‚Äì Quel composant stocke une charge √©lectrique ?\nBonne r√©ponse : üü° Condensateur",
  "üí° Quizz 5 ‚Äì √Ä quoi sert la fonction delay() sur Arduino ?\nBonne r√©ponse : üî¥ Attendre un certain temps",
  "üí° Quizz 6 ‚Äì L‚ÄôIA apprend √† partir de :\nBonne r√©ponse : üü° Donn√©es",
  "üí° Quizz 7 ‚Äì Un neurone artificiel :\nBonne r√©ponse : üî¥ Traite un signal d‚Äôentr√©e",
  "üí° Quizz 8 ‚Äì Le machine learning sert √† :\nBonne r√©ponse : üü£ Pr√©dire √† partir d‚Äôexemples",
  "üí° Quizz 9 ‚Äì Le deep learning utilise :\nBonne r√©ponse : üü° Des r√©seaux de neurones profonds",
  "üí° Quizz 10 ‚Äì Une image peut √™tre comprise par une IA en la transformant en :\nBonne r√©ponse : üü° Donn√©es num√©riques",
  "üí° Quizz 11 ‚Äì Le capteur LDR d√©tecte :\nBonne r√©ponse : üî¥ La lumi√®re",
  "üí° Quizz 12 ‚Äì Quelle fonction mesure une tension analogique sur Arduino ?\nBonne r√©ponse : üü° analogRead()",
  "üí° Quizz 13 ‚Äì L‚Äôunit√© de la tension est :\nBonne r√©ponse : üü° Volt",
  "üí° Quizz 14 ‚Äì En IA, NLP signifie :\nBonne r√©ponse : üî¥ Natural Language Processing",
  "üí° Quizz 15 ‚Äì L‚ÄôIA g√©n√©rative peut :\nBonne r√©ponse : üî¥ √âcrire des textes, images, sons",
  "üí° Quizz 16 ‚Äì Quel composant est polaris√© ?\nBonne r√©ponse : üî¥ LED",
  "üí° Quizz 17 ‚Äì Que mesure le capteur DHT11 ?\nBonne r√©ponse : üî¥ Temp√©rature et humidit√©",
  "üí° Quizz 18 ‚Äì L‚Äôapprentissage supervis√© signifie :\nBonne r√©ponse : üî¥ On lui fournit des exemples avec r√©ponses",
  "üí° Quizz 19 ‚Äì Une breadboard sert √† :\nBonne r√©ponse : üî¥ Prototyper sans souder",
  "üí° Quizz 20 ‚Äì Une IA bien entra√Æn√©e peut :\nBonne r√©ponse : üî¥ R√©pondre avec logique sur des cas appris"
];


// 'TTECH‚Ñ¢ |  G√©n√©ral'
const groupName = 'TTECH‚Ñ¢ |  G√©n√©ral'; // Nom du groupe
const mediaDir = path.join(__dirname, 'media/answers'); // Dossier image
let currentIndex = 0;

//=============================== CLIENT INIT ===============================//
const client = new Client({
  authStrategy: new LocalAuth(),
  puppeteer: {
    executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox'],
  },
});

client.on('qr', qr => {
  console.log('üì≤ Scanner ce QR code avec WhatsApp :');
  qrcode.generate(qr, { small: true });
});

client.on('ready', () => {
  console.log('‚úÖ Client WhatsApp pr√™t !');

  // Cron tous les jours √† 8h GMT (changer √† */1 * * * * pour test rapide)
  cron.schedule('30 18 * * *', async () => {
    try {
      const message = '[ orax - bot ] Reponse ' + reponses[currentIndex] + "\n Vous pouvez me poser des question en tapant d'abord !ask";
      currentIndex = (currentIndex + 1) % reponses.length; // Boucle circulaire

      const chats = await client.getChats();
      const group = chats.find(chat => chat.isGroup && chat.name === groupName);

      if (!group) {
        console.error(`‚ùå Groupe "${groupName}" non trouv√©.`);
        return;
      }

      const images = fs.readdirSync(mediaDir).filter(file => /\.(jpg|jpeg|webp|png)$/i.test(file));
      if (images.length === 0) {
        console.error('‚ùå Aucune image trouv√©e dans le dossier media.');
        return;
      }

      const randomImage = images[Math.floor(Math.random() * images.length)];
      const imagePath = path.join(mediaDir, randomImage);
      const media = MessageMedia.fromFilePath(imagePath);

      await client.sendMessage(group.id._serialized, media, { caption: message });
      console.log(`[ orax - bot ] ‚úÖ Message + image "${randomImage}" envoy√©s dans "${groupName}"`);
    } catch (err) {
      console.error('‚ùå Erreur lors de l‚Äôenvoi :', err);
    }
  });
});

client.on('auth_failure', msg => {
  console.error('‚ùå Authentification √©chou√©e :', msg);
});

client.on('disconnected', reason => {
  console.log('üîå D√©connect√© :', reason);
});

client.initialize();
// je dois push le projet !!

client.on('message', async message => {
  if (!message.fromMe && message.body.startsWith('!ask')) {
    const question = message.body.replace('!ask', '').trim();

    if (!question) {
      await message.reply("‚ùå Pose une vraie question apr√®s !ask");
      return;
    }

    try {
      const res = await fetch('http://localhost:11434/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'mistral',
          prompt: question,
          stream: false
        })
      });

      const data = await res.json();
      await message.reply("[ orax - bot ] ü§ñ " + data.response.trim());
    } catch (err) {
      console.error("Erreur:", err);
      await message.reply("‚ùå Erreur en appelant Mistral.");
    }
  }
});